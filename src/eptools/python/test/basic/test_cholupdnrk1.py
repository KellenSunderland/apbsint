#! /usr/bin/env python

import numpy as np
import apbsint as abt

# Helper functions

def maxreldiff(a,b):
    return (np.abs(a-b)/np.maximum(np.maximum(np.abs(a),np.abs(b)),1e-8)).max()

# I/O generated by matlab/test/basic/test_cholupdnrk1.m

lfact = np.array([[8.3033086285545287807963177e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-2.8565097159532981674345820e-01, 5.8860897380357912744841542e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-8.3136651156762431114088940e-01, 1.0186852821285754533420231e+00, 6.7852506102343890237449386e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-9.7920630516730211567733022e-01, -1.3321747950773468738283611e-01, 3.0753515923825192057705635e-01, 3.3728357977152145785737503e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-1.1564016556640022148627622e+00, -7.1453016378715838996527054e-01, -1.2571183593520534049758908e+00, -1.3028465314572063027398485e-01, 5.5884882817993108972132177e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-5.3355710931598743229642423e-01, 1.3513857684266568082165350e+00, -8.6546803055480381328123940e-01, 1.8368909586194212546494953e-01, 1.2606587091208962814192773e+00, 1.0630885392869129368875747e+00, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-2.0026357358830604304955614e+00, -2.2477105605258410059299479e-01, -1.7653411423145093372966130e-01, -4.7615301661907383223848456e-01, 6.6014314104697768836871319e-01, -2.0971333838873670862845700e-01, 6.4680571873896797185921059e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [9.6422942263162747522642348e-01, -5.8902903072080126101184305e-01, 7.9141606162863398221674061e-01, 8.6202161155692202942901758e-01, -6.7865553542687334642735664e-02, 6.2519035708762571434959909e-01, -1.4605463433152618413224388e-01, 6.2113583080400147640176556e-01, 0000000000000000000000000, 0000000000000000000000000], \
 [5.2006010145545755740670302e-01, -2.9375359773541609431646293e-01, -1.3320044213152473222550043e+00, -1.3616944708707543476577939e+00, -1.9522119789875436168813394e-01, 1.8322726300143696298583507e-01, -5.3201137680882071290255908e-01, -1.0642134128893268041338160e+00, 3.3159438670852381392251118e-01, 0000000000000000000000000], \
 [-2.0027851642538077592270440e-02, -8.4792624363793389630217234e-01, -2.3298671558050760843627813e+00, 4.5502955644433434878592948e-01, -2.1760635014319193447640544e-01, -1.0297675435666211463114905e+00, 1.6821035946631788249305828e+00, 1.6034572981200441166294013e+00, -1.2506789068264074771263950e+00, 5.8889774392016691617612878e-01]],order='F')
zmat = np.array([[2.3234701262447676750610981e-01, -3.7280874172350420003851923e-01, 2.0236908866030534071001057e+00, 2.2294456804568989483072983e+00, 1.0000608195891247387265821e+00, -5.9003456420522149006302470e-01, 4.2271569122047830679989033e-01, 4.7163432641630270714117046e-01, 6.6190048424611416799656638e-02, 3.2705996717708751830855363e-01], \
 [4.2638755740894501711224507e-01, -2.3645458375718628185602199e-01, -2.2583539704961914651448751e+00, 3.3756370061310642105567581e-01, -1.6641644749870603270380798e+00, -2.7806416376530934675415097e-01, -1.6702006978504704282073590e+00, -1.2128471996744594196826483e+00, 6.5235588866137395047672953e-01, 1.0826335042367560834719598e+00]],order='F')
vec = np.array([1.0060771108190513789537590e+00, -6.5090773659775258419557531e-01, 2.5705615743396886818672442e-01, -9.4437780640421897793146400e-01, -1.3217885213925637533094459e+00, 9.2482593349370589841385026e-01, 4.9849075250813308288460463e-05, -5.4918914609406697946436537e-02, 9.1112726565385981913891555e-01, 5.9458369740905236966455050e-01])
yvec = np.array([3.5020117387453519874895846e-01, 1.2502512283049957986236222e+00])
pvec = np.array([7.7125388101057334999666182e-01, -1.9926074004100211012335819e-01, 5.1232817672378427875656826e-01, -1.6672220309894866807631786e-01, 2.2120501975817810635938088e-01, -3.3162586077901595738026685e-02, -6.0507729276895648451439769e-02, -4.0580182867232639232213387e-02, -6.4006738203784108165450562e-02, 1.1350755256349331911991385e-01])
lfact1 = np.array([[1.3044694303525439238455874e+00, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-6.8383986010710884340113580e-01, 6.1975876670439888904695636e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-3.3093221402129036068373580e-01, 7.1554206828997068967623818e-01, 1.2782204525524354377097325e+00, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-1.3516469380162792202071387e+00, -1.7475993855787919084576743e-01, 2.5193572862805097001270838e-01, 3.9473702761831624963306808e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-1.7555161569807617993888016e+00, -6.9443335305628273168565556e-01, -8.1621954143359243261102165e-01, -6.1636434157229968988644941e-01, 9.4571756452719923924377099e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [3.7365173677327651047264112e-01, 9.7036222097919444529168231e-01, 7.0412514689283411950526670e-01, -6.0274546527575534327070272e-01, 1.8299026677357035364224203e+00, 1.0860788913729197968649487e+00, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-1.2746945753247396204699271e+00, -6.9699187387448269248579891e-01, 1.0898533336961901962780530e+00, -8.6973197488790932041524684e-01, 8.0467735001529594462965633e-01, -1.5843126180135541636317953e-01, 6.9972863753142022780195930e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [5.7140226378730851752862918e-01, -3.1568097895728375323898263e-01, -3.6285323995038004651902952e-01, 1.3398009974206908090366142e+00, -4.7919229771944588103238516e-01, 6.6657818978435534607029922e-01, -8.4161642865519997736001301e-02, 6.4639118354155089551937863e-01, 0000000000000000000000000, 0000000000000000000000000], \
 [1.0337430747083602433633587e+00, -3.3497992247987973257750127e-01, -6.4104702260593726670379056e-01, -1.7714566253461709877115027e+00, 1.2055341845305016235112561e-01, 1.1174793248331391093408627e-01, -6.2942296390985585929911394e-01, -1.0587693363297079329754524e+00, 3.7223139397255411431331140e-01, 0000000000000000000000000], \
 [4.4582670284327424736758871e-01, -9.2862111899222599120662380e-01, -1.1446737972355913726119070e+00, -6.6698826737872507486315499e-01, 1.4629305994097125953601335e+00, -1.2824953842447186502795375e+00, 1.1343914416220095553455849e+00, 1.0811737301565909064038351e+00, -2.0407673327187421108419585e+00, 1.3805216971151428317909904e+00]],order='F')
zmat1 = np.array([[4.1798931274621098364008276e-01, -3.6775538052042211489833790e-01, 1.0105272674490330953034345e+00, 2.8166990923743844277282733e+00, 3.1567183230174095109887844e-01, -3.7115397272802652661738421e-01, 8.1339074436167080328630163e-01, 6.9202108525570826813577696e-01, 3.7633082378274640422688435e-01, -3.9609308419032474013476985e-01], \
 [1.2356685825819859747554119e+00, -3.7075082892540833778838305e-01, -8.8569367871706394801378792e-01, -8.0779455550969392341187358e-01, 6.1254187163265017002089508e-01, -7.8620759739328494042354123e-01, -2.4600530397397823989535937e+00, -1.6035309834875821621835712e+00, 4.2698468024831570666322023e-02, 1.6847476935949856624574750e+00]],order='F')
lfact2 = np.array([[8.3033086285545287807963177e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-2.8565097159532992776576066e-01, 5.8860897380357923847071788e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-8.3136651156762442216319187e-01, 1.0186852821285754533420231e+00, 6.7852506102343856930758648e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-9.7920630516730244874423761e-01, -1.3321747950773457636053365e-01, 3.0753515923825114342093912e-01, 3.3728357977152190194658488e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-1.1564016556640019928181573e+00, -7.1453016378715850098757301e-01, -1.2571183593520529608866809e+00, -1.3028465314572290623118533e-01, 5.5884882817993053460980946e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-5.3355710931598721025181931e-01, 1.3513857684266565861719300e+00, -8.6546803055480348021433201e-01, 1.8368909586193804539533403e-01, 1.2606587091208969475530921e+00, 1.0630885392869127148429698e+00, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [-2.0026357358830604304955614e+00, -2.2477105605258451692662902e-01, -1.7653411423145082270735884e-01, -4.7615301661907549757302149e-01, 6.6014314104697580098957133e-01, -2.0971333838873693067306192e-01, 6.4680571873896830492611798e-01, 0000000000000000000000000, 0000000000000000000000000, 0000000000000000000000000], \
 [9.6422942263162747522642348e-01, -5.8902903072080103896723813e-01, 7.9141606162863409323904307e-01, 8.6202161155692369476355452e-01, -6.7865553542683615395603169e-02, 6.2519035708762449310427201e-01, -1.4605463433152704455508797e-01, 6.2113583080400069924564832e-01, 0000000000000000000000000, 0000000000000000000000000], \
 [5.2006010145545766842900548e-01, -2.9375359773541620533876539e-01, -1.3320044213152473222550043e+00, -1.3616944708707552358362136e+00, -1.9522119789876052342592061e-01, 1.8322726300143932220976239e-01, -5.3201137680881771530039259e-01, -1.0642134128893243616431619e+00, 3.3159438670852642294661905e-01, 0000000000000000000000000], \
 [-2.0027851642538119225633864e-02, -8.4792624363793389630217234e-01, -2.3298671558050760843627813e+00, 4.5502955644432874215965512e-01, -2.1760635014319151814277120e-01, -1.0297675435666191479100462e+00, 1.6821035946631739399492744e+00, 1.6034572981200516661459687e+00, -1.2506789068264294595422825e+00, 5.8889774392012195214363146e-01]],order='F')
zmat2 = np.array([[2.3234701262447673975053419e-01, -3.7280874172350408901621677e-01, 2.0236908866030538511893155e+00, 2.2294456804569007246641377e+00, 1.0000608195891331764215693e+00, -5.9003456420522604197742567e-01, 4.2271569122047553124232877e-01, 4.7163432641629532415805670e-01, 6.6190048424615538502635559e-02, 3.2705996717716373511919414e-01], \
 [4.2638755740894507262339630e-01, -2.3645458375718636512274884e-01, -2.2583539704961923533232948e+00, 3.3756370061310070340709899e-01, -1.6641644749870609931718946e+00, -2.7806416376530407319478400e-01, -1.6702006978504746470548525e+00, -1.2128471996744529803891055e+00, 6.5235588866134863739176808e-01, 1.0826335042368238070764619e+00]],order='F')

r, n = zmat.shape
cvec = np.zeros(n); svec = np.zeros(n); workv = np.zeros(n)

lfact1b = lfact.copy(order='F')
zmat1b = zmat.copy(order='F')
stat = abt.eptools_ext.choluprk1(lfact1b,'L',vec,cvec,svec,workv,zmat1b,yvec)
print 'CHOLUPRK1: rdf(L) = %f, rdf(Z) = %f' % \
    (maxreldiff(lfact1,lfact1b), maxreldiff(zmat1,zmat1b))

lfact2b = lfact1b.copy(order='F')
zmat2b = zmat1b.copy(order='F')
stat = abt.eptools_ext.choldnrk1(lfact2b,'L',pvec,cvec,svec,workv,zmat2b,yvec)
print 'CHOLDNRK1: rdf(L) = %f, rdf(Z) = %f' % \
    (maxreldiff(lfact2,lfact2b), maxreldiff(zmat2,zmat2b))
